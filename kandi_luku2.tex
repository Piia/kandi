% !TEX root = kandi.tex

\section{Jatkuva integraatio}


Jatkuva integraatio on suosittu työskentelytapa sekä ohjelmistoteollisuudessa että avoimen lähdekoodin projekteissa (open source projects) \cite{HTH+16}. Ohjelmistokehittäjät pitävät jatkuvasta integraatiosta ja kokevat sen käytön hyödyllisenä \cite{MSB17}. Esimerkiksi erään tutkimuksen mukaan tuhansia ohjelmistokehittäjiä työllistävissä yrityksissä työskentelevät ohjelmistokehittäjät suhtautuvat erittäin myönteisesti jatkuvaan integraatioon. He antoivat asteikolla 1-5 jatkuvalle integraatiolle arvosanaksi 4,13. Suurin osa näistä ohjelmistokehittäjistä myös noudatti jatkuvan integraation suosituksia kommitointitiheydestä, eli he kommitoivat työnsä vähintään kerran päivässä. Tahtia pidettiin sopivana kaikille ohjelmistokehittäjille. Toisaalta ohjelmistokehittäjillä on vaikeuksia kommitoida ohjelmistokehityksen päälinjaan ja he käyttävät usein suositusten vastaisesti versionhallinnan sivuhaaroja (branch).

\begin{figure}[h]
    \centering
    \includegraphics[width=0.7\textwidth]{fig2.pdf}
    \caption{Avoimen lähdekoodin projektit, joissa käytetään jatkuvaa integraatiota \cite{HTH+16}.}
    \label{fig2}
\end{figure}

Avoimen lähdekoodin projekteissa jatkuvan integraation käyttö on kasvanut huimasti. Kuvassa \ref{fig2} on jatkuvaa integraatiota käyttäviä avoimia projekteja GitHub-pilvipalvelusta vuosilta 2011-2016. Vielä vuonna 2011 projektien määrä on lähellä nollaa, mutta vuosittain jatkuvan integraation käyttö on lisääntynyt lineaarisesti noin sadalla projektilla vuodessa. Myös avoimen lähdekoodin parissa työskentelevät ohjelmistokehittäjät käyttävät jatkuvaa integraatiota mielellään. Kyselytutkimuksessa (katso kuva \ref{fig3}) kävi ilmi, että noin 70 prosenttia vastaajista käyttäisi ehdottomasti jatkuvaa integraatiota seuraavassa projektissaan. Kiinnostavinta on kuitenkin se, että vain marginaalinen osa vastaajista ei sitä käyttäisi. \cite{HTH+16}

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{fig3.pdf}
    \caption{Käyttäisivätkö avoimen lähdekoodin projekteissa työskentelevät ohjelmistokehittäjät jatkuvaa integraatiota seuraavassa projektissaan \cite{HTH+16}.}
    \label{fig3}
\end{figure}

Trendikkyydestä huolimatta jatkuvan integraation suosion ei odoteta laskevan tulevaisuudessa. Tähän viittaa se, että jatkuvan integraation käyttö madaltaa selvästi kynnystä ottaa osaa avoimen lähdekoodin projektiin. Mitä suositumpi projekti, sitä todennäköisemmin jatkuva integraatio on käytössä. Projektien parissa työskentelevien on helpompi ottaa puoltopyyntöjä (pull request) vastaan, kun jatkuvan integraation palvelin toimii kommitin oikeellisuuden puolueettomana varmistajana. \cite{HTH+16}

Jatkuvaa integraatiota suitsutetaan paljon, mutta osin katteettomasti. Vaikka jatkuvasta integraatiosta näyttäisi olevan hyötyä, hyödyn määrittely ja arviointi on vaikeaa \cite{SB13}. Hyvä esimerkki tästä on ohjelmistokehittäjien taipumus vältellä koontiversion epäonnistumista. Huolellisuus ja ohjelmiston päälinjan stabiiliudesta huolehtiminen on tärkeää, kun saman päälinjan parissa työskentelee monia ohjelmistokehittäjiä. Toisaalta kommitointia edeltävään testaamiseen voi kuluttaa liikaa aikaa ja palvelinresursseja, jotka ovat pois muista toiminnoista \cite{HTH+16}.

Ohjelmistokehittäjät noudattavat jatkuvan integraation tarkkoja käytänteitä mielellään, jos se on heidän kannaltaan tarpeenmukaista \cite{MSB17}. Monet heistä eivät näe eroa versionhallinnan päälinjaan ja sivuhaaraan kommitoimisen välillä. Toisaalta kaikki ohjelmistokehittäjät eivät tunne jatkuvaa integraatiota tarpeeksi voidakseen ottaa sitä käyttöön ja harjoittaa sitä suositusten mukaisesti \cite{HTH+16}. Suurin osa jatkuvan integraation ongelmista ja käyttöönoton esteistä on ratkaistavissa käytännön olosuhteita muuttamalla \cite{PRC17}.


\subsection{Koontiversio}

Integraatiossa ohjelmisto kootaan jatkuvan integraation palvelimella, jolloin ajetaan myös ohjelmakoodin sisältämät automatisoidut testit \cite{Fow06}. Palvelin antaa palautetta koonnin ja testaamisen koko ohjelmistokehitystiimille. Koontiversion epäonnistuessa ohjelmistokehittäjän kuuluu tehdä välittömästi toimenpiteitä, joilla koontiversion status muuttuu onnistuneeksi. Tässä teoria ja käytäntö eivät aina kohtaa ja havaintojen mukaan koontiversion statuksesta ja ohjelmiston laadusta ei viestitä tarpeeksi \cite{SB13}. Ilmeisesti ohjelmistokehittäjät jättävät kommunikoinnin täysin jatkuvan integraation palvelimen vastuulle.

Testaaminen ennen kommitointia on tärkeää, jotta koontiversion status pysyy onnistuneena \cite{ERP14}. Näin yhteisen ohjelmiston parissa työskentelevät ohjelmistokehittäjät voivat luottaa työskentelevänsä toimivan ohjelmakoodin varassa \cite{MSB17}. Turvallisuuskriittisissä ohjelmistoissa testaaminen on vieläkin tärkeämpää ja tällaiseen ohjemistoon kohdistuvat muutokset ovat kokonaisvaltaisempia kuin esimerkiksi web-sovelluksissa, joita kehitetään lähempänä tuotantoa ja tuotanto-olosuhteita \cite{LGL+16}. Ketterän testaamisen (agile testing) harjoittaminen korreloi jatkuvan integraation kanssa, mutta kyseessä lienee syy-seuraussuhteen sijaan siitä, että projekteissa omaksutaan kerralla useita ketteriä menetelmiä \cite{SB13}.

Koontiversion onnistuminen tarkoittaa kommitin hyväksymistä osaksi ohjelmiston päälinjaa. Koontiversion epäonnistuminen sen sijaan tarkoittaa sitä, että ohjelmiston uusin versio on tavalla tai toisella rikki ja se on korjattava välittömästi. Tähän kuluu luonnollisesti aikaa. Jatkuvan integraation ja jatkuvan integraation palvelimen tarkoitus on löytää virheitä, mutta vain 65 prosenttia epäonnistuneista koontiversioista sisälsi ohjelmointivirheen. Mikäli virhe löydetään, se voidaan korjata, kun taas muut epäonnistumiseen johtaneet syyt hidastavat ohjelmiston kehittämistä. Virhe voi esimerkiksi sijaita testissä tai testi voi olla epädeterministinen, eli se antaa epäluotettavia tuloksia. \cite{LIH17}

Koontiversion epäonnistumiseen johtavat syyt voivat olla myös sosiaalisia, kuten esimerkiksi riittämätön testaaminen tai kiireinen aikataulu \cite{PRC17}. On myös tutkittu, että ohjelmistokehittäjät luottavat liikaa testien virheettömyyteen. Koontiversioiden epäonnistumiseen johtavien seikkojen projektikohtainen analysointi kannattaa rahallisesti, sillä turhaan epäonnistuneet koontiversiot kuluttavat resursseja \cite{ERP14}.

\subsection{Jatkuvan integraation hyvät ja huonot puolet}

Jatkuvan integraation tärkein hyöty on virheiden löytyminen aikaisin, minkä vuoksi projektien aikataulu on helpommin ennustettavissa \cite{HTH+16}. Sen omaksuminen nopeuttaa ohjelmistotuotantoprosessia ja mahdollistaa ripeämmän julkaisusyklin \cite{PRC17}. Myös avoimen lähdekoodin projekteissa puoltopyynnöt (pull request) hyväksytään nopeammin. Jatkuva integraatio lisää sekä sisäistä että ulkoista viestintää, mikä mahdollistaa rinnakkaisen ohjelmistokehityksen \cite{SB13}. Se ei kuitenkaan korvaa ohjelmiston tilasta kommunikointia, vaikka virheiden löytäminen ja versioiden yhteenliittäminen (merge) olisikin helpompaa.

Jatkuva integraatio vaatii ohjelmistokehittäjiltä ainakin aluksi itsekuria \cite{PRC17}. Sitä tukee myös hyvä testaamiskulttuuri ja käytänteet, joiden pariin uudet työntekijät muistetaan tutustuttaa. Kuten aiemmin tässä luvussa käytiin läpi, ohjelmistokehittäjät välttelevät liikaa koontiversion testien epäonnistumista ja tähän ilmiöön voidaan parhaiten puuttua työyhteisön tasolla \cite{HTH+16}. 

Testaaminen on olennainen osa jatkuvaa integraatiota \cite{LGL+16}. Testien kirjoittamiseen ja ylläpitämiseen meneekin paljon enemmän työaikaa kuin itse ohjelmakoodin kirjoittamiseen \cite{LIH17}. Lisäkustannuksia voi tulla projektista riippuen ostopalveluista ja välineistä. Testeihin luotetaan liikaa, vaikka ne voivat olla epädeterministisiä tai kattavuudeltaan huonoja. Jatkuva integraatio voi hämärtää eri testitoimintojen ja niiden käyttötarkoitusten rajoja ohjelmistokehittäjän mielessä.

\begin{table}[!htbp]
  \centering
	\input{taulukko1}
  \caption{Teemakartoitus ohjelmistokehittäjien esteistä kommitoida päivittäin ohjelmiston versionhallinnan päälinjaan \cite{MSB17}.}
  \label{tab:taulukko1}
\end{table}

Ohjelmistokehittäjät toteuttaisivat integraatiot useammin, mikäli työ olisi pilkottavissa ja järkevästi ajoitettu (katso taulukko \ref{tab:taulukko1}). Ohjelmiston arkkitehtuurin on siis jatkuvan integraation kannalta hyvä koostua itsenäisistä osista. Lisäksi testaamisen työkalujen ja prosessien on oltava nopeita ja helppoja, jotta niiden käyttö olisi mahdollisimman luontevaa. Nämä ovat periaatteessa helppoja tapoja luoda sopivat olosuhteet jatkuvan integraation käytölle, mutta käytännössä kaiken muuttaminen kerralla olisi haasteellista. \cite{MSB17} 

Jatkuva integraatio on työskentelytapana sellainen, että se rytmittää ohjelmistokehittäjän arkea \cite{MSB17}. Tämän vuoksi jatkuvan integraation prosessien vaivattomuudella on iso vaikutus ohjelmistokehittäjän tyytyväisyyteen ja halukkuuteen toteuttaa jatkuvaa integraatiota. Automatisoitu testaaminen ja neutraalin jatkuvan integraation palvelimen käyttäminen testaamiseen helpottaa virheiden löytymistä, mutta silti ohjelmiston kehitys- ja testaamisvälineet eivät aina ole yhteensopivia \cite{LGL+16}. Avoimen lähdekoodin projekteissa korostuu jatkuvan integraation palvelimen konfigurointi, joka voi osoittautua erittäin haasteelliseksi tehtäväksi \cite{PRC17}.



\subsection{Case: Jatkuva integraatio Googlella}

Google on valtava, kansainvälinen tekniikan alan yritys, jossa tuotetaan myös valtavasti ohjelmistoja. Jatkuva integraatio on otettu siellä viime vuosina vaiheittain käyttöön. Tässä mittakaavassa jatkuvan integraation järjestäminen on mielenkiintoinen esimerkki. \cite{MGN+17}

Google käyttää testaamiseen  TAP-nimistä (Test Automation Platform) testialustaa. TAP suorittaa päivittäin noin 800 000 koontiversiota, mikä on suuruusluokkaa yksi sekunnissa. Se aiheuttaa TAP:lle suorituspaineita, varsinkin kun ajan mittaan sekä testipohjan koko että kommittien saapumistiheys ovat kasvaneet lineaarisesti. Ympäri maailmaa sijoittuneet ohjelmistokehitystiimit tasaavat TAP:n kuormitusta, mutta suurin piikki kommiteissa on lounasaikaan USA:n Californian osavaltiossa. Seuraavaksi suurin piikki on työpäivän loppuessa. \cite{MGN+17}

%\begin{figure}[h]
%    \centering
%   \includegraphics[width=\textwidth]{kommitointiajat.pdf}
%    \caption{Kommitien saapuminen TAP-testialustalle eri vuorokaudenaikoina Yhdysvaltain Californian osavaltion ajassa \cite{ERP14}.}
%    \label{kommitointiajat}
%\end{figure}

Jatkuva integraatio on Googlella ennen kaikkea hyvin järjestettyä testaamista \cite{MGN+17}. TAP:n vastuulla on testaaminen sekä ennen että jälkeen kommitoinnin. Kommittien määrä ja koodipohjan koko ovat valtavia, jonka vuoksi koodipohjan analysointiin perustuvien työkalujen käyttö ei onnistu \cite{ERP14}. Testaamisesta ja TAP:sta huolehtii erillinen testaamistiimi, mutta ohjelmistokehittäjät kirjoittavat itse testit ja kokoavat testikokonaisuudet. Testaamisen keskittämistä helpottaa se, että kaikissa testikohteissa käytetään XUnit-tyyppistä testikehystä. Näin kaikkia testikohteita voidaan käsitellä yhtenäisesti.

Googlen koodipohja on jaettu paketteihin (package), joita vastaavat itsenäisesti koottavat testikohteet (test-target) \cite{MGN+17}. Ohjelmistokehittäjät liittävät TAP:lle lähtevään kommittiin muutoslistan (changelist), johon on listattu kommitissa muutettuja paketteja vastaavat testikohteet. TAP aloittaa kommitin käsittelyn muutoslistasta. Listan sisällölle etsitään riippuvuusanalyysillä riippuvuudet ja riippuvaisuudet. Niitä tosin approksimoidaan voimakkaasti \cite{ERP14}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{fig_changelist.pdf}
    \caption{Kommitien kerääntyminen yhden virstanpylvään aikana. Testikohteista ajetaan vain viimeisimmät kommitit, jotka on kuvassa väritetty mustaksi. \cite{MGN+17}}
    \label{fig_changelist}
\end{figure}

Googlella huomattiin, että TAP ajoi lyhyen ajan sisällä useasti samoja testikohteita. Se kulutti tarpeettomasti resursseja, joten Googlella päädyttiin ratkaisuun, jossa TAP kerää kommitteja 45 minuuttia ennen testikohteiden ajoa. Tätä aikaa kutsutaan nimellä milestone, eli suomeksi virstanpylväs. Kuva \ref{fig_changelist} havainnollistaa kommitien keräämistä virstanpylvään aikana. Kun aika on kulunut, jokaisesta testikohteesta ajetaan vain viimeisin kommit. Esimerkiksi testikohde t1 esiintyy muutoslistoilla cl1, cl3 ja cl16. \par Testikohteesta t1 ajetaan lopuksi vain muutoslistan cl16 versio. \cite{MGN+17}

Testaamisen onnistumisesta lähtee ohjelmistokehittäjälle viesti, joka erittelee tulokset testikohteen tarkkuudella \cite{ERP14}. Ohjelmistokehittäjän on korjattava epäonnistuneita testikohteita vastaavat paketit välittömästi. Jatkuvan integraation suositusten mukaisesti kommitin lähettämisestä tulisi kulua korkeintaan kymmenen minuuttia palautteen saamiseen. Googlella, kuten muillakaan suurilla yrityksillä, se ei ole realistinen tavoite. TAP:lle lähetetty kommit odottaa parhaassa tapauksessa ajoa kokonaisen virstanpylvään verran. Viipeitä aiheuttavat myös esimerkiksi muistin loppuminen, ohjelmiston kaatuminen ja laitteisto-ongelmat\cite{MGN+17}.




\clearpage
